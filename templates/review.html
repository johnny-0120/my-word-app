{% extends 'base.html' %}

{% block title %}ç¶“å…¸å¡«ç©ºæ¸¬é©—{% endblock %}

{% block content %}
<div id="review-container">
    </div>

<div class="grid" style="margin-top: 1rem;">
    <a id="next-word-btn" href="#" role="button" class="contrast" style="display: none;">ä¸‹ä¸€é¡Œ -></a>
    <a href="{{ url_for('review_choice') }}" role="button" class="secondary">è¿”å›æ¨¡å¼é¸æ“‡</a>
</div>

<script>
    // æ‰¾åˆ°æˆ‘å€‘è¦æ“ä½œçš„ HTML å…ƒç´ 
    const reviewContainer = document.getElementById('review-container');
    const nextWordBtn = document.getElementById('next-word-btn');
    let currentWord = null;

    // å‡½å¼ï¼šç”¨ä¾†ç”¢ç”Ÿå•é¡Œçš„ HTML å…§å®¹
    function renderQuestion(word) {
        currentWord = word;
        let exampleSentenceHTML = '';
        if (word.example_sentence) {
            const clozeSentence = word.example_sentence.replace(word.word, '_______');
            exampleSentenceHTML = `<p><strong>ä¾‹å¥å¡«ç©º:</strong> ${clozeSentence}</p>`;
        }

        reviewContainer.innerHTML = `
            <article>
                <header><h2>ç¶“å…¸å¡«ç©ºæ¸¬é©—</h2></header>
                <p><strong>å®šç¾©:</strong> ${word.definition}</p>
                ${exampleSentenceHTML}
                <form id="cloze-form">
                    <input type="text" name="guess" placeholder="è«‹åœ¨æ­¤è¼¸å…¥ç­”æ¡ˆ" required autofocus>
                    <input type="hidden" name="word_id" value="${word.id}">
                    <button type="submit">é€å‡ºç­”æ¡ˆ</button>
                </form>
            </article>
        `;
        // ç‚ºæ–°çš„è¡¨å–®åŠ ä¸Šäº‹ä»¶ç›£è½
        document.getElementById('cloze-form').addEventListener('submit', handleFormSubmit);
        nextWordBtn.style.display = 'none'; // éš±è—ä¸‹ä¸€é¡ŒæŒ‰éˆ•
    }

    // å‡½å¼ï¼šç”¨ä¾†ç”¢ç”Ÿçµæœçš„ HTML å…§å®¹
    function renderResult(result) {
        let resultHTML = '';
        if (result.is_correct) {
            resultHTML = `
                <hgroup>
                    <h1 style="color: var(--pico-color-green-500);">ğŸ‰ ç­”å°äº†ï¼ ğŸ‰</h1>
                </hgroup>
            `;
        } else {
            resultHTML = `
                <hgroup>
                    <h1 style="color: var(--pico-color-red-500);">ğŸ˜¥ ç­”éŒ¯äº†... ğŸ˜¥</h1>
                    <h2>ä½ çš„ç­”æ¡ˆ: ${result.user_guess}</h2>
                </hgroup>
            `;
        }

        resultHTML += `
            <article>
                <header><strong>æ­£ç¢ºç­”æ¡ˆæ˜¯: ${result.correct_word.word}</strong></header>
                <p><strong>å®šç¾©:</strong> ${result.correct_word.definition}</p>
                <footer><em>ä¾‹å¥: ${result.correct_word.example_sentence}</em></footer>
            </article>
        `;

        if (result.explanation) {
            resultHTML += `
            <article style="background-color: var(--pico-color-amber-100); border-color: var(--pico-color-amber-400);">
                <header><strong>ğŸ’¡ AI å­¸ç¿’ç­†è¨˜ï¼š</strong></header>
                <pre style="white-space: pre-wrap; word-wrap: break-word;">${result.explanation}</pre>
            </article>
            `;
        }
        reviewContainer.innerHTML = resultHTML;
        nextWordBtn.style.display = 'block'; // é¡¯ç¤ºä¸‹ä¸€é¡ŒæŒ‰éˆ•
    }

    // å‡½å¼ï¼šè™•ç†è¡¨å–®æäº¤
    async function handleFormSubmit(event) {
        event.preventDefault(); // é˜»æ­¢é é¢åˆ·æ–°ï¼

        const formData = new FormData(event.target);
        const data = {
            guess: formData.get('guess'),
            word_id: formData.get('word_id')
        };

        const response = await fetch('/api/check/cloze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        renderResult(result);
    }

    // å‡½å¼ï¼šå–å¾—ä¸‹ä¸€å€‹å–®å­—
    async function fetchNextWord() {
        const response = await fetch('/api/review/next_word');
        const word = await response.json();
        renderQuestion(word);
    }

    // ç•¶é é¢è¼‰å…¥æ™‚ï¼Œè‡ªå‹•å–å¾—ç¬¬ä¸€å€‹å–®å­—
    fetchNextWord();

    // ç‚ºã€Œä¸‹ä¸€é¡Œã€æŒ‰éˆ•åŠ ä¸Šé»æ“Šäº‹ä»¶
    nextWordBtn.addEventListener('click', (event) => {
        event.preventDefault();
        fetchNextWord();
    });
</script>
{% endblock %}